<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Timetable</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function printPDF() {
            window.print();
        }
    </script>
</head>

<body class="bg-light">

    <!-- Screen Controls -->
    <div class="container my-4 no-print text-end">
        <button onclick="printPDF()" class="btn btn-primary shadow-sm me-2">Print as PDF üñ®Ô∏è</button>
        <a href="/" class="btn btn-outline-secondary">Create New ‚Ü∫</a>
    </div>

    <!-- =========================
         SCREEN VIEW (Hidden on Print)
         ========================= -->
    <div class="container printable-screen mb-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">Your Preparation Schedule</h1>
            <p class="text-muted">Generated by NEET PG Timetable AI</p>
        </div>

        <!-- Duration Stats -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-4">
                <div class="row text-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <small class="text-muted fw-bold text-uppercase d-block">Total Duration</small>
                        <span class="display-6 fw-bold text-dark">{{ stats.total_days }} <span
                                class="fs-4">Days</span></span>
                    </div>
                    {% if stats.main_days > 0 %}
                    <div class="col-md-4 mb-3 mb-md-0 border-start border-end">
                        <small class="text-muted fw-bold text-uppercase d-block">Main Phase</small>
                        <span class="display-6 fw-bold text-primary">{{ stats.main_days }} <span
                                class="fs-4">Days</span></span>
                    </div>
                    {% endif %}
                    <div class="col-md-4">
                        <small class="text-muted fw-bold text-uppercase d-block">Revision Phase</small>
                        <span class="display-6 fw-bold text-success">{{ stats.rev_days }} <span
                                class="fs-4">Days</span></span>
                    </div>
                </div>
            </div>
        </div>

        {% if main.days %}
        <div class="card shadow-sm border-0 mb-5">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h2 class="h4 fw-bold text-primary border-bottom pb-2 d-inline-block">Part I: Main Timetable</h2>
            </div>
            <div class="card-body px-4">

                <!-- Summary Accordion -->
                <div class="accordion mb-4" id="mainSummaryAcc">
                    <div class="accordion-item border-0 shadow-sm">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed bg-light text-dark fw-semibold" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                View Subject Breakdown (Summary)
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#mainSummaryAcc">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Subject</th>
                                                <th>Total Hours</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for subj, count in main.summary.items() %}
                                            <tr>
                                                <td>{{ subj }}</td>
                                                <td><span class="badge bg-primary rounded-pill">{{ count }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Table -->
                <div class="schedule-box">
                    <h5 class="fw-bold mb-3 text-secondary">Detailed Schedule</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle bg-white">
                            <thead class="table-primary text-nowrap">
                                <tr>
                                    <th>Date (Day)</th>
                                    {% for col_time in time_cols %}
                                    <th>{{ col_time }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in main.days %}
                                <tr
                                    class="{% if day.is_special %}text-white {% if 'Grand Test' in day.special_label %}bg-danger{% else %}bg-success{% endif %}{% endif %}">
                                    <td class="fw-bold text-start text-nowrap bg-light sticky-col">{{ day.date_display
                                        }}</td>

                                    {% if day.is_special %}
                                    <td colspan="{{ time_cols|length }}" class="fw-bold text-uppercase py-3"
                                        style="letter-spacing:1px;">
                                        {{ day.special_label }}
                                    </td>
                                    {% else %}
                                    {% for col_time in time_cols %}
                                    <td class="small">
                                        {{ day.slots_map.get(col_time, '-') }}
                                    </td>
                                    {% endfor %}
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if rev.days %}
        <div class="card shadow-sm border-0 mb-5">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h2 class="h4 fw-bold text-success border-bottom pb-2 d-inline-block">Part II: Revision Timetable</h2>
            </div>
            <div class="card-body px-4">

                <!-- Revision Summary Accordion -->
                <div class="accordion mb-4" id="revSummaryAcc">
                    <div class="accordion-item border-0 shadow-sm">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-light text-dark fw-semibold" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseRev">
                                View Revision Breakdown
                            </button>
                        </h2>
                        <div id="collapseRev" class="accordion-collapse collapse" data-bs-parent="#revSummaryAcc">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Subject</th>
                                                <th>Total Hours</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for subj, count in rev.summary.items() %}
                                            <tr>
                                                <td>{{ subj }}</td>
                                                <td><span class="badge bg-success rounded-pill">{{ count }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="schedule-box">
                    <h5 class="fw-bold mb-3 text-secondary">Detailed Schedule</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle bg-white">
                            <thead class="table-success text-nowrap">
                                <tr>
                                    <th>Date (Day)</th>
                                    {% for col_time in time_cols %}
                                    <th>{{ col_time }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in rev.days %}
                                <tr
                                    class="{% if day.is_special %}text-white {% if 'Grand Test' in day.special_label %}bg-danger{% else %}bg-success{% endif %}{% endif %}">
                                    <td class="fw-bold text-start text-nowrap bg-light sticky-col">{{ day.date_display
                                        }}</td>

                                    {% if day.is_special %}
                                    <td colspan="{{ time_cols|length }}" class="fw-bold text-uppercase py-3"
                                        style="letter-spacing:1px;">
                                        {{ day.special_label }}
                                    </td>
                                    {% else %}
                                    {% for col_time in time_cols %}
                                    <td class="small">
                                        {{ day.slots_map.get(col_time, '-') }}
                                    </td>
                                    {% endfor %}
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- =========================
         PDF VIEW (Visible ONLY on Print)
         ========================= -->
    <div class="pdf-container">

        <!-- COVER PAGE -->
        <div class="pdf-page d-flex justify-content-center align-items-center text-center">
            <div style="margin-top: 30vh;">
                <h1 style="font-size: 40px; margin-bottom: 20px;">NEET PG PREPARATION SCHEDULE</h1>
                <p style="font-size: 18px; font-style: italic;">Personalized Timetable</p>
                <br>
                <div class="pdf-stats" style="margin-top: 40px;">
                    <div class="p-stat"><strong>Total:</strong> {{ stats.total_days }} Days</div>
                    <div class="p-stat"><strong>Main Phase:</strong> {{ stats.main_days }} Days</div>
                    <div class="p-stat"><strong>Revision:</strong> {{ stats.rev_days }} Days</div>
                </div>
            </div>
            <div class="pdf-footer">
                "Preparation is the key to success."
            </div>
        </div>

        <!-- MAIN SCHEDULE PAGES -->
        {% if main.days %}
        <!-- chunk size 13 for landscape fit -->
        {% for batch in main.days | batch(13) %}
        <div class="pdf-page">
            <div class="pdf-header-sm">
                <h3>Main Timetable - Schedule (Page {{ loop.index }})</h3>
            </div>

            <table class="pdf-table matrix-sm">
                <thead>
                    <tr>
                        <th style="width: 100px;">Date</th>
                        {% for col_time in time_cols %}
                        <th>{{ col_time }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in batch %}
                    <tr class="{% if day.is_special %}special-row{% endif %}">
                        <td class="date-cell">{{ day.date_display }}</td>

                        {% if day.is_special %}
                        <td colspan="{{ time_cols|length }}"
                            class="merged-cell-pdf {{ day.special_label|lower|replace(' ', '-') }}">
                            {{ day.special_label }}
                        </td>
                        {% else %}
                        {% for col_time in time_cols %}
                        <td>{{ day.slots_map.get(col_time, '-') }}</td>
                        {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Quote -->
            <div class="pdf-footer quote-box">
                {% set q_idx = loop.index0 % quotes|length %}
                "{{ quotes[q_idx] }}"
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- REVISION SCHEDULE PAGES -->
        {% if rev.days %}
        {% for batch in rev.days | batch(13) %}
        <div class="pdf-page">
            <div class="pdf-header-sm">
                <h3>Revision Timetable - Schedule (Page {{ loop.index }})</h3>
            </div>

            <table class="pdf-table matrix-sm">
                <thead>
                    <tr>
                        <th style="width: 100px;">Date</th>
                        {% for col_time in time_cols %}
                        <th>{{ col_time }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in batch %}
                    <tr class="{% if day.is_special %}special-row{% endif %}">
                        <td class="date-cell">{{ day.date_display }}</td>

                        {% if day.is_special %}
                        <td colspan="{{ time_cols|length }}"
                            class="merged-cell-pdf {{ day.special_label|lower|replace(' ', '-') }}">
                            {{ day.special_label }}
                        </td>
                        {% else %}
                        {% for col_time in time_cols %}
                        <td>{{ day.slots_map.get(col_time, '-') }}</td>
                        {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="pdf-footer quote-box">
                {% set q_idx = (loop.index0 + 5) % quotes|length %}
                "{{ quotes[q_idx] }}"
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- SUMMARY PAGE (Last Page) -->
        <div class="pdf-page">
            <div class="pdf-header">
                <h1>TIMETABLE SUMMARY</h1>
            </div>

            <div style="display: flex; gap: 40px; justify-content: center; margin-top: 20px;">
                {% if main.days %}
                <div style="flex: 1;">
                    <div class="pdf-section">
                        <h2>Main Phase Breakdown</h2>
                        <table class="pdf-table summary-sm">
                            <tr>
                                <th>Subject</th>
                                <th>Hours</th>
                            </tr>
                            {% for subj, count in main.summary.items() %}
                            <tr>
                                <td>{{ subj }}</td>
                                <td>{{ count }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
                {% endif %}

                {% if rev.days %}
                <div style="flex: 1;">
                    <div class="pdf-section">
                        <h2>Revision Phase Breakdown</h2>
                        <table class="pdf-table summary-sm">
                            <tr>
                                <th>Subject</th>
                                <th>Hours</th>
                            </tr>
                            {% for subj, count in rev.summary.items() %}
                            <tr>
                                <td>{{ subj }}</td>
                                <td>{{ count }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="pdf-footer quote-box" style="margin-top: auto;">
                "Believe you can and you're halfway there."
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>